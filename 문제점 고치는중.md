- [P0] src/main/java/com/example/crud/ai/embedding/EmbeddingApiClient.java:51 ìºì‹œ í‚¤ë¥¼
  text.trim().toLowerCase().hashCode()ë¡œ ë§Œë“¤ë©´ì„œ ì‹¤ì œ OpenAI ìš”ì²­ì—ëŠ” ì›ë³¸ í…ìŠ¤íŠ¸ë¥¼ ê·¸ëŒ€ë¡œ ë³´
  ë‚´ê³  ìˆìŠµë‹ˆë‹¤. ê³µë°±Â·ëŒ€ì†Œë¬¸ìë§Œ ë‹¤ë¥¸ ì…ë ¥ì´ í†µí•©ë˜ê±°ë‚˜, í•´ì‹œ ì¶©ëŒì´ ë‚˜ë©´ ì•„ì˜ˆ ë‹¤ë¥¸ ë¬¸ì¥ë„ ê°™ì€
  í‚¤ë¡œ ì·¨ê¸‰ë˜ì–´ í‹€ë¦° ì„ë² ë”©ì„ ëŒë ¤ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìºì‹œ í‚¤ë¥¼ ì›ë³¸ í…ìŠ¤íŠ¸ ê·¸ëŒ€ë¡œ(í˜¹ì€ ì•ˆì •ì ì¸ ë°”
  ì´íŠ¸ í•´ì‹œ)ë¡œ ë§ì¶”ê³ , í•„ìš”í•˜ë‹¤ë©´ í˜ì´ë¡œë“œë„ ë™ì¼í•œ ì •ê·œí™”ë¥¼ ì ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
- [P0] src/main/java/com/example/crud/ai/common/VectorFormatter.java:13ì— ìˆëŠ” DecimalFormatì€
  ìŠ¤ë ˆë“œ ì„¸ì´í”„í•˜ì§€ ì•Šì€ë° ì •ì  í•„ë“œë¡œ ê³µìœ ë˜ê³  ìˆìŠµë‹ˆë‹¤. RecommendationTestControllerì˜ /text
  íë¦„ì´ ë™ì‹œì— ì—¬ëŸ¬ ìš”ì²­ì„ ì²˜ë¦¬í•˜ë©´ í¬ë§· ê²°ê³¼ê°€ ë’¤ì„ì´ê±°ë‚˜ NumberFormatExceptionì´ í„°ì§ˆ ìˆ˜ ìˆ
  ìŠµë‹ˆë‹¤. ThreadLocal<DecimalFormat>ì„ ì“°ê±°ë‚˜ ë§¤ í˜¸ì¶œë§ˆë‹¤ ìƒˆ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë§Œë“¤ì–´ì•¼ ì•ˆì „í•©ë‹ˆë‹¤.
- [P1] src/main/java/com/example/crud/ai/recommendation/application/
  RecommendationEngine.java:51ì™€ src/main/java/com/example/crud/ai/recommendation/
  infrastructure/ProductVectorService.java:77ì—ì„œ exceptionallyë¡œ ì˜ˆì™¸ë¥¼ ì¡ì€ ë’¤ List.of()ë¥¼ ë°˜
  í™˜í•˜ê³  ìˆìŠµë‹ˆë‹¤. OpenAI í˜¸ì¶œ ì‹¤íŒ¨ë‚˜ DB ì˜¤ë¥˜ê°€ ë‚˜ë„ ì»¨íŠ¸ë¡¤ëŸ¬ëŠ” 200 OKì™€ ë¹ˆ ì¶”ì²œ ëª©ë¡ì„ ë‚´ë ¤ë²„
  ë ¤ ë¬¸ì œë¥¼ ìˆ¨ê¹ë‹ˆë‹¤. ì—¬ê¸°ì„œëŠ” ì˜ˆì™¸ë¥¼ ê·¸ëŒ€ë¡œ ë‹¤ì‹œ ë˜ì§€ê±°ë‚˜ CompletableFuture.failedFuture(e)ë¡œ
  ë³€í™˜í•´ í˜¸ì¶œìê°€ ì‹¤íŒ¨ë¥¼ ê°ì§€í•  ìˆ˜ ìˆê²Œ í•´ì•¼ í•©ë‹ˆë‹¤.
- [P1] src/main/java/com/example/crud/ai/recommendation/infrastructure/
  ProductVectorService.java:31-45ì˜ thenApply ì²´ì¸ì€ ì„ë² ë”© APIë¥¼ ëŒë ¤ë°›ì€ ë’¤ ê°™ì€ ë¹„ë™ê¸° ìŠ¤
  ë ˆë“œì—ì„œ JPA ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤. ì™¸ë¶€ API ëŒ€ê¸° + DB ë¸”ë¡œí‚¹ì´ ë™ì¼ í’€ì—ì„œ ì¼ì–´ë‚˜
  embeddingTaskExecutorê°€ ê¸ˆë°© ë§‰í ìˆ˜ ìˆìœ¼ë‹ˆ, DB í˜¸ì¶œì€ CompletableFuture.supplyAsync(...,
  otherExecutor) ë“± ë³„ë„ í’€ë¡œ ë¶„ë¦¬í•˜ê±°ë‚˜ ìµœìƒìœ„ì—ì„œ ë™ê¸° ë¡œì§ìœ¼ë¡œ ë‹¨ìˆœí™”í•˜ëŠ” í¸ì´ ë‚«ìŠµë‹ˆë‹¤.
- [P2] src/main/java/com/example/crud/ai/recommendation/presentation/
  RecommendationTestController.java:108-124ì—ì„œ BeanUtils.copyPropertiesì™€
  NumberFormat.getNumberInstanceë¥¼ ê²°ê³¼ í•­ëª©ë§ˆë‹¤ ì‹¤í–‰í•´ ë¶ˆí•„ìš”í•œ ë¦¬í”Œë ‰ì…˜Â·ê°ì²´ ìƒì„±ì„ ë°˜ë³µí•©ë‹ˆ
  ë‹¤. DTO í•„ë“œê°€ ë§ì§€ ì•Šìœ¼ë‹ˆ ì§ì ‘ ë§¤í•‘í•˜ê³ , í†µí™” í¬ë§·í„°ëŠ” ThreadLocal ìºì‹œë‚˜ DecimalFormat ì¬ì‚¬
  ìš©ìœ¼ë¡œ ë¹„ìš©ì„ ì¤„ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜í•œ ProductVectorServiceê°€ ì´ë¯¸ ìƒí’ˆëª…Â·ì„¤ëª…ì„ ëŒë ¤ì£¼ëŠ”ë° ì¶”
  ê°€ ì¿¼ë¦¬ë¡œ ë‹¤ì‹œ ë¡œë”©í•˜ëŠ” ê²ƒë„ í•„ìš” ìµœì†Œí•œì˜ í•„ë“œë§Œ ì¡°íšŒí•˜ë„ë¡ ì¡°ì •í•˜ëŠ” ê²Œ ì¢‹ìŠµë‹ˆë‹¤.





## 3. ë³‘ëª© ì§€ì  ìƒì„¸ ë¶„ì„

### ğŸ”´ Critical (ì‹¬ê°) - ì¦‰ì‹œ í•´ê²° í•„ìš”

---

#### ë³‘ëª© #1: OpenAI API ë™ê¸° ë¸”ë¡œí‚¹ + ìºì‹œ ë¯¸ì‚¬ìš©

**ğŸ“ ìœ„ì¹˜**: `EmbeddingApiClient.java:36, 69-70`

**âŒ ë¬¸ì œ ì½”ë“œ**:
```java
// @Cacheable(value = "embeddings", ...) // â† ìºì‹œ ë¹„í™œì„±í™”!!!
public float[] generateEmbedding(String text) {
    // ...
    Map<String, Object> response = webClient.post()
        .uri("https://api.openai.com/v1/embeddings")
        .timeout(Duration.ofSeconds(3))
        .block();  // â† ë™ê¸° ë¸”ë¡œí‚¹ (ì›¹ ìŠ¤ë ˆë“œ ì ìœ )
}
```

**ğŸ› ë¬¸ì œì **:

1. **ìŠ¤ë ˆë“œ í’€ ê³ ê°ˆ**
    - Tomcat ê¸°ë³¸ ìŠ¤ë ˆë“œ: 200ê°œ
    - ë™ì‹œ ìš”ì²­ 100ê°œ â†’ ê°ê° 3ì´ˆ ëŒ€ê¸° â†’ 300ê°œ ìŠ¤ë ˆë“œ í•„ìš”
    - ê²°ê³¼: íì—ì„œ ëŒ€ê¸° â†’ íƒ€ì„ì•„ì›ƒ â†’ ì„œë¹„ìŠ¤ ì „ì²´ ë§ˆë¹„

2. **ìºì‹œ ë¹„í™œì„±í™”ë¡œ ì¤‘ë³µ í˜¸ì¶œ**
    - "íŒŒë€ìƒ‰ ì…”ì¸ " ì¿¼ë¦¬ê°€ 100ë²ˆ ë“¤ì–´ì˜¤ë©´ â†’ **100ë²ˆ API í˜¸ì¶œ**
    - OpenAI Rate Limit: ë¶„ë‹¹ 3,000 requests â†’ ì‰½ê²Œ ë„ë‹¬
    - API ë¹„ìš©: $0.0001/1K tokens Ã— 100íšŒ = ë¶ˆí•„ìš”í•œ ë¹„ìš©

3. **ì—ëŸ¬ ì „íŒŒ**
    - OpenAI API ì¥ì•  ì‹œ ì „ì²´ ì¶”ì²œ ì‹œìŠ¤í…œ ë‹¤ìš´
    - 429 (Rate Limit) ì—ëŸ¬ â†’ ì—°ì‡„ ì‹¤íŒ¨

**ğŸ“Š ìˆ˜ì¹˜í™”**:

| ì‹œë‚˜ë¦¬ì˜¤ | í˜„ì¬ | ì˜í–¥ |
|---------|------|------|
| ë™ì‹œ 100 ìš”ì²­ | ìˆœì°¨ ì²˜ë¦¬ â†’ 300ì´ˆ | ìŠ¤ë ˆë“œ í’€ ê³ ê°ˆ |
| ë™ì¼ ì¿¼ë¦¬ 100íšŒ | 100ë²ˆ API í˜¸ì¶œ | $0.01 ë¹„ìš© + 300ì´ˆ |
| OpenAI ì¥ì•  | ì „ì²´ ì„œë¹„ìŠ¤ ë‹¤ìš´ | 100% ì‹¤íŒ¨ìœ¨ |

**âœ… í•´ê²° ë°©ë²•**:

**í˜„ì¬ ìƒí™©**:
- âœ… Redis ìºì‹œ ì´ë¯¸ í™œì„±í™”ë¨ (`EmbeddingApiClient.java:34`)
- âœ… AsyncConfig ì´ë¯¸ ì¡´ì¬ (`common/config/AsyncConfig.java`)
- âŒ ë¹„ë™ê¸° ë©”ì„œë“œ ì—†ìŒ (line 69 ì£¼ì„ì— TODO ëª…ì‹œ)

**ì‹¤ì œ ì ìš©**:

```java
// 1. AsyncConfig ìŠ¤ë ˆë“œ í’€ ì¦ê°€ (common/config/AsyncConfig.java:33-38 ìˆ˜ì •)
@Bean(name = "embeddingTaskExecutor")  // ì´ë¯¸ ìˆëŠ” Bean ì´ë¦„ ì‚¬ìš©
public TaskExecutor embeddingTaskExecutor() {
    ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
    executor.setCorePoolSize(20);    // ê¸°ì¡´: 2 â†’ 20
    executor.setMaxPoolSize(50);     // ê¸°ì¡´: 10 â†’ 50
    executor.setQueueCapacity(100);  // ìœ ì§€
    executor.setThreadNamePrefix("Embedding-");
    executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
    executor.initialize();
    return executor;
}

// 2. ë¹„ë™ê¸° ë©”ì„œë“œ ì¶”ê°€ (EmbeddingApiClient.java:100ì— ì¶”ê°€)
@Async("embeddingTaskExecutor")  // ê¸°ì¡´ Bean ì´ë¦„ ì‚¬ìš©
@Cacheable(value = "embeddings", key = "#text.trim().toLowerCase().hashCode()")
public CompletableFuture<float[]> generateEmbeddingAsync(String text) {
    if (text == null || text.trim().isEmpty()) {
        return CompletableFuture.failedFuture(
            new NullPointerException("ì„ë² ë”© ìƒì„±í•  í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.")
        );
    }
    try {
        float[] result = generateEmbedding(text);  // ê¸°ì¡´ ë©”ì„œë“œ ì¬ì‚¬ìš©
        return CompletableFuture.completedFuture(result);
    } catch (Exception e) {
        return CompletableFuture.failedFuture(e);
    }
}

// 3. Circuit Breaker (ì„ íƒì )
@CircuitBreaker(name = "openai", fallbackMethod = "getDefaultEmbeddingAsync")
@Async("embeddingTaskExecutor")
@Cacheable(value = "embeddings", key = "#text.trim().toLowerCase().hashCode()")
public CompletableFuture<float[]> generateEmbeddingAsync(String text) {
    // ...
}
```

**ğŸ¯ ì˜ˆìƒ ê°œì„ **:

| ì§€í‘œ | ê°œì„  ì „ | ê°œì„  í›„ | ë°°ìœ¨ |
|------|---------|---------|------|
| ìºì‹œ íˆíŠ¸ ì‹œ ì‘ë‹µ ì‹œê°„ | 3,000ms | **10ms** | **300ë°°** |
| ë™ì‹œ 100 ìš”ì²­ ì²˜ë¦¬ | 300ì´ˆ | **3ì´ˆ** | **100ë°°** |
| API í˜¸ì¶œ íšŸìˆ˜ (ìºì‹œ íˆíŠ¸ìœ¨ 80%) | 100íšŒ | **20íšŒ** | **5ë°°** |
| TPS | 0.33 | **33+** | **100ë°°** |










#### ë³‘ëª© #2: CAST ì—°ì‚°ìœ¼ë¡œ pgvector ì¸ë±ìŠ¤ ë¯¸ì‚¬ìš©

**ğŸ“ ìœ„ì¹˜**: `ProductRepository.java:56-72`

**âŒ ë¬¸ì œ ì½”ë“œ**:
```sql
SELECT
    p.number as productId,
    p.name as productName,
    p.description as description,
    (1 - (CAST(p.description_vector AS vector) <=> CAST(:queryVector AS vector))) as similarity
FROM product p
WHERE p.description_vector IS NOT NULL
AND (1 - (CAST(p.description_vector AS vector) <=> CAST(:queryVector AS vector))) > :threshold
ORDER BY (CAST(p.description_vector AS vector) <=> CAST(:queryVector AS vector))
LIMIT :limit
```

**ğŸ› ë¬¸ì œì **:

1. **description_vectorê°€ TEXT íƒ€ì…ìœ¼ë¡œ ì €ì¥ë¨**
    - pgvectorëŠ” `vector(1536)` íƒ€ì…ì—ë§Œ ì¸ë±ìŠ¤ ìƒì„± ê°€ëŠ¥
    - TEXT íƒ€ì…ì—ëŠ” IVFFlat/HNSW ì¸ë±ìŠ¤ ë¶ˆê°€

2. **ë§¤ ì¿¼ë¦¬ë§ˆë‹¤ CAST ìˆ˜í–‰**
    - ì „ì²´ í–‰ ìŠ¤ìº” â†’ ê° í–‰ë§ˆë‹¤ TEXTë¥¼ vectorë¡œ íŒŒì‹±
    - "[0.123,0.456,...]" (15KB ë¬¸ìì—´) â†’ float[1536] ë³€í™˜
    - ìƒí’ˆ 10ë§Œ ê°œ â†’ 10ë§Œ ë²ˆ íŒŒì‹±

3. **ì¸ë±ìŠ¤ë¥¼ íƒˆ ìˆ˜ ì—†ìŒ**
    - `CAST()` í•¨ìˆ˜ ì‚¬ìš© ì‹œ PostgreSQLì€ ì¸ë±ìŠ¤ ìŠ¤ìº” ë¶ˆê°€
    - ë¬´ì¡°ê±´ Sequential Scan




**âœ… í•´ê²° ë°©ë²•**:


**Step 2: ì¸ë±ìŠ¤ ìƒì„±**
```sql
-- IVFFlat ì¸ë±ìŠ¤ (ë¹ ë¥¸ ê²€ìƒ‰, ì•½ê°„ì˜ ì •í™•ë„ ì†ì‹¤)
CREATE INDEX product_vector_ivfflat_idx
ON product
USING ivfflat (description_vector vector_cosine_ops)
WITH (lists = 100);  -- ìƒí’ˆ ìˆ˜ / 1000

-- ë˜ëŠ” HNSW ì¸ë±ìŠ¤ (ë” ì •í™•, ë” ëŠë¦° ì¸ë±ìŠ¤ êµ¬ì¶•)
CREATE INDEX product_vector_hnsw_idx
ON product
USING hnsw (description_vector vector_cosine_ops)
WITH (m = 16, ef_construction = 64);
```



**ğŸ¯ ì˜ˆìƒ ê°œì„ **:

| ì§€í‘œ | ê°œì„  ì „ (CAST) | ê°œì„  í›„ (ì¸ë±ìŠ¤) | ë°°ìœ¨ |
|------|---------------|-----------------|------|
| ì¿¼ë¦¬ ì‹¤í–‰ ì‹œê°„ | 5,000ms | **50ms** | **100ë°°** |
| ìŠ¤ìº” ë°©ì‹ | Sequential Scan | Index Scan | - |
| CPU ì‚¬ìš©ë¥  | 80% | **10%** | **8ë°°** |
| ë™ì‹œ ì²˜ë¦¬ëŸ‰ | 20 QPS | **200+ QPS** | **10ë°°** |

---







#### ë³‘ëª© #3: ë™ì  ì„ê³„ê°’ìœ¼ë¡œ ì¸í•œ ë‹¤ì¤‘ ì¿¼ë¦¬

**ğŸ“ ìœ„ì¹˜**: `ProductVectorService.java:140-167`

**âŒ ë¬¸ì œ ì½”ë“œ**:
```java
private List<Object[]> findWithDynamicThreshold(String vectorString, int limit) {
    double[] thresholds = {0.5, 0.4, 0.3};  // 3ë²ˆ ì‹œë„

    for (double threshold : thresholds) {
        List<Object[]> results = productRepository.findSimilarProductsByVector(
            vectorString, threshold, limit
        );
        if (!results.isEmpty()) {
            return results;  // ê²°ê³¼ ìˆìœ¼ë©´ ë°˜í™˜
        }
    }

    // ìµœì¢… ì‹œë„ (0.25)
    return productRepository.findSimilarProductsByVector(vectorString, 0.25, limit);
    // ìµœì•…ì˜ ê²½ìš° 4ë²ˆ ì¿¼ë¦¬ ì‹¤í–‰
}
```

**ğŸ› ë¬¸ì œì **:

1. **ìµœëŒ€ 4ë²ˆì˜ DB ì¿¼ë¦¬**
    - ê° ì¿¼ë¦¬ë§ˆë‹¤ Full Table Scan (CAST ë¬¸ì œì™€ ê²°í•©)
    - 0.5 â†’ 0.4 â†’ 0.3 â†’ 0.25 ìˆœì°¨ ì‹¤í–‰
    - íŠ¸ë˜í”½ ë†’ì„ ë•Œ DB ë¶€í•˜ 4ë°° ì¦ê°€

2. **ë¹„íš¨ìœ¨ì ì¸ ë¡œì§**
    - ê°€ì¥ ë‚®ì€ ì„ê³„ê°’ í•˜ë‚˜ë§Œ ì¨ë„ ë™ì¼ ê²°ê³¼
    - ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œ í•„í„°ë§ ê°€ëŠ¥

**ğŸ“Š ìˆ˜ì¹˜í™”**:

| ì‹œë‚˜ë¦¬ì˜¤ | ì¿¼ë¦¬ íšŸìˆ˜ | ì†Œìš” ì‹œê°„ (CAST ì‚¬ìš©) |
|---------|----------|---------------------|
| 0.5ì—ì„œ ê²°ê³¼ ë°œê²¬ | 1íšŒ | 5ì´ˆ |
| 0.3ì—ì„œ ê²°ê³¼ ë°œê²¬ | 3íšŒ | 15ì´ˆ |
| 0.25ì—ì„œ ê²°ê³¼ ë°œê²¬ | 4íšŒ | 20ì´ˆ |

**âœ… í•´ê²° ë°©ë²•**:


**Option 2: ì¸ë±ìŠ¤ ê°œì„  í›„ ì„ê³„ê°’ ê³ ì •**
```java
// ì¸ë±ìŠ¤ ì‚¬ìš© ì‹œ ë¹ ë¥´ë¯€ë¡œ 0.3 ê³ ì •
public List<ProductSimilarity> findSimilarProducts(String queryText, int limit) {
    return productRepository.findSimilarProductsByVector(
        vectorString, 0.3, limit  // í•œ ë²ˆë§Œ ì¡°íšŒ
    );
}
```

**ğŸ¯ ì˜ˆìƒ ê°œì„ **:

| ì§€í‘œ | ê°œì„  ì „ | ê°œì„  í›„ | ë°°ìœ¨ |
|------|---------|---------|------|
| DB ì¿¼ë¦¬ íšŸìˆ˜ | í‰ê·  3íšŒ | **1íšŒ** | **3ë°°** |
| ì¿¼ë¦¬ ì‹œê°„ (ì¸ë±ìŠ¤ ì‚¬ìš©) | 150ms (3íšŒ) | **50ms** (1íšŒ) | **3ë°°** |



#### ë³‘ëª© #4: N+1 ì¿¼ë¦¬ ë¬¸ì œ

**ğŸ“ ìœ„ì¹˜**: `ConversationalRecommendationService.java:152-191`

**âŒ ë¬¸ì œ ì½”ë“œ**:
```java
private List<ProductResponseDto> convertToProductResponseDtos(List<ProductMatch> matches) {
    return matches.stream()
        .map(match -> {
            // ê° ìƒí’ˆë§ˆë‹¤ ê°œë³„ ì¡°íšŒ (N+1 ë¬¸ì œ)
            Product product = productRepository.findById(match.id()).orElse(null);
            if (product == null) {
                return createDefaultDto(match);
            }
            return convertToDto(product);
        })
        .collect(Collectors.toList());
}
```

**ğŸ› ë¬¸ì œì **:

1. **ì¶”ì²œ ìƒí’ˆ 5ê°œ â†’ DB ì¡°íšŒ 5ë²ˆ**
    - SELECT * FROM product WHERE number = ?  (Ã— 5)
    - ê° ì¿¼ë¦¬ë§ˆë‹¤ ë„¤íŠ¸ì›Œí¬ ì™•ë³µ

2. **Connection Pool ë‚­ë¹„**

**âœ… í•´ê²° ë°©ë²•**:

```java
private List<ProductResponseDto> convertToProductResponseDtos(List<ProductMatch> matches) {
    // 1. ëª¨ë“  IDë¥¼ í•œ ë²ˆì— ì¡°íšŒ
    List<Long> productIds = matches.stream()
        .map(ProductMatch::id)
        .collect(Collectors.toList());

    Map<Long, Product> productMap = productRepository.findAllById(productIds)
        .stream()
        .collect(Collectors.toMap(Product::getNumber, p -> p));

    // 2. ë§¤ì¹­í•´ì„œ DTO ë³€í™˜
    return matches.stream()
        .map(match -> {
            Product product = productMap.get(match.id());
            return product != null ? convertToDto(product) : createDefaultDto(match);
        })
        .collect(Collectors.toList());
}
```

**ğŸ¯ ì˜ˆìƒ ê°œì„ **:

| ì§€í‘œ | ê°œì„  ì „ | ê°œì„  í›„ | ë°°ìœ¨ |
|------|---------|---------|------|
| DB ì¿¼ë¦¬ íšŸìˆ˜ | 5íšŒ | **1íšŒ** | **5ë°°** |
| ì¿¼ë¦¬ ì‹œê°„ | 100ms | **20ms** | **5ë°°** |

---

#### ë³‘ëª© #5: ë©”ì‹œì§€ ì €ì¥ ë™ê¸°í™”

**ğŸ“ ìœ„ì¹˜**: `ConversationalRecommendationService.java:64-79`

**âŒ ë¬¸ì œ ì½”ë“œ**:
```java
public RecommendationResponseDto processUserMessage(Long id, String message) {
    // 1. ìœ ì € ë©”ì‹œì§€ ì €ì¥ (ë™ê¸°)
    commandService.addMessage(id, MessageType.USER, message);

    // 2. ì¶”ì²œ ë¡œì§
    List<ProductMatch> recommendations = recommendationEngine.getRecommendations(message, 5);
    String aiResponse = generateAIResponse(recommendations);

    // 3. AI ì‘ë‹µ ì €ì¥ (ë™ê¸°)
    commandService.addMessage(id, MessageType.ASSISTANT, aiResponse);

    return buildResponse(...);
}
```

**ğŸ› ë¬¸ì œì **:

1. **ë¶ˆí•„ìš”í•œ ëŒ€ê¸°**
    - ë©”ì‹œì§€ ì €ì¥(DB INSERT) ì™„ë£Œê¹Œì§€ ì‘ë‹µ ì§€ì—°
    - ì‚¬ìš©ìëŠ” ë©”ì‹œì§€ ì €ì¥ ì™„ë£Œë¥¼ ê¸°ë‹¤ë¦´ í•„ìš” ì—†ìŒ

2. **ì£¼ì„ì—ë„ ëª…ì‹œ**: "ë¹„ë™ê¸°ë¡œ ìµœì í™” ê°€ëŠ¥"

**âœ… í•´ê²° ë°©ë²•**:

```java
public RecommendationResponseDto processUserMessage(Long id, String message) {
    // 1. ë¹„ë™ê¸° ë©”ì‹œì§€ ì €ì¥ (fire-and-forget)
    CompletableFuture.runAsync(() ->
        commandService.addMessage(id, MessageType.USER, message)
    );

    // 2. ì¶”ì²œ ë¡œì§ (ë™ê¸°)
    List<ProductMatch> recommendations = recommendationEngine.getRecommendations(message, 5);
    String aiResponse = generateAIResponse(recommendations);

    // 3. ë¹„ë™ê¸° ì‘ë‹µ ì €ì¥
    CompletableFuture.runAsync(() ->
        commandService.addMessage(id, MessageType.ASSISTANT, aiResponse)
    );

    return buildResponse(...);
}
```

**ğŸ¯ ì˜ˆìƒ ê°œì„ **:

| ì§€í‘œ | ê°œì„  ì „ | ê°œì„  í›„ | ë°°ìœ¨ |
|------|---------|---------|------|
| ì‘ë‹µ ì‹œê°„ | 3,810ms | **3,610ms** | 1.05ë°° |
| ë©”ì‹œì§€ ì €ì¥ ëŒ€ê¸° | 200ms | **0ms** | - |

---


