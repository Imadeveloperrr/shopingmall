<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: fragment-header"></head>
<body>
    <!-- 내비게이션 (원래 위치: head 밖 body 상단) -->
    <div th:replace="fragments/nav :: fragment-nav"></div>

    <div id="wrapper">
        <div id="cnt" class="member">
            <div class="maincontent">
                <!-- 페이지 상단 헤더 -->
                <div class="top">
                    <div class="wrap_inner">
                        <!-- 브레드크럼 네비게이션 -->
                        <div class="navi">
                            홈 &gt;
                            <a href="/mypage">마이페이지 &gt;</a>
                            <a href="/cart" class="active">장바구니</a>
                        </div>

                        <div>
                            <div class="title">장바구니</div>

                            <!-- 마이페이지 메뉴 (원본 구조) -->
                            <div id="my_menu" class="my_menu">
                                <dl id="favor" style="background-color:#fff">
                                    <dt>즐겨찾기</dt>
                                </dl>
                                <dl>
                                    <dt><img src="https://atimg.sonyunara.com/2023/renew/list/mypage_1.png" class="icon" alt="">주문관리</dt>
                                    <dd class="order">
                                        <a href="/orders">주문/배송조회</a>
                                        <a class="star1" onclick="stargo('order')"></a>
                                    </dd>
                                    <dd class="today_goods">
                                        <a href="/products/recent">최근 본 상품</a>
                                        <a class="star1" onclick="stargo('today_goods')"></a>
                                    </dd>
                                    <dd class="cart">
                                        <a href="/cart" class="active">장바구니</a>
                                        <a class="star1" onclick="stargo('cart')"></a>
                                    </dd>
                                    <dd class="wish">
                                        <a href="/wishlist">좋아요</a>
                                        <a class="star1" onclick="stargo('wish')"></a>
                                    </dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 장바구니 메인 컨텐츠 -->
                <div id="cart" class="wrap_inner">
                    <!-- 좌측 상품 목록 -->
                    <div class="area_left">
                        <form class="goods-form"></form>

                        <!-- 헤더 (선택, 주문단계) -->
                        <div class="cart-sub-header">
                            <div class="left-content">
                                <ul>
                                    <label>
                                        <input type="checkbox" id="selectAll" onclick="toggleAllItems()">
                                        전체상품<span class="checkgh">[</span><span id="selectedCount">0</span><span class="checkgh">/</span><span id="totalCount" th:text="${cart.cartItems.size()}">0</span><span class="checkgh">]</span>
                                    </label>
                                </ul>
                            </div>
                            <div class="right-content">
                                <ol class="order_step_new">
                                    <li class="cart active">장바구니</li>
                                    <li class="order">주문/결제</li>
                                    <li class="finish">주문완료</li>
                                </ol>
                                <a class="choose_del" href="javascript:void(0);" onclick="deleteSelectedItems()">선택삭제</a>
                            </div>
                        </div>

                        <!-- 상품 리스트 -->
                        <ul class="prd list">
                            <li th:each="item : ${cart.cartItems}" th:id="'cartItem-' + ${item.id}">
                                <form class="goods-form">
                                    <div class="check">
                                        <input type="checkbox" class="itemCheckbox" th:value="${item.id}" onclick="updateTotalPrice()">
                                    </div>
                                    <div class="img">
                                        <a th:href="@{/product/detail/{id}(id=${item.productId})}">
                                            <img th:src="${item.imageUrl}" alt="상품 이미지">
                                        </a>
                                    </div>
                                    <div class="tal">
                                        <div>
                                            <span style="color:#cf591f">[오늘출발] <img src="https://atimg.sonyunara.com/2023/renew/m/quick_m.png" style="height:15px; margin-right:5px; vertical-align: middle;"></span>
                                        </div>
                                        <div class="name">
                                            <a th:href="@{/product/detail/{id}(id=${item.productId})}" target="_blank">
                                                <span th:text="${item.productName}">상품명</span>
                                            </a>
                                        </div>
                                    </div>
                                    <div class="opt">
                                        <div class="current-option">
                                            <span th:text="${item.productColor}">Color</span> / <span th:text="${item.productSize}">Size</span>
                                        </div>
                                        <div class="box_btn w80 h30 white5" style="display:block; margin-top:10px;">
                                            <button type="button"
                                                    th:data-product-id="${item.productId}"
                                                    th:data-item-id="${item.id}"
                                                    th:data-color="${item.productColor}"
                                                    th:data-size="${item.productSize}"
                                                    onclick="openOptionModal(this)">옵션변경</button>
                                        </div>
                                        <div th:id="'optionModal-' + ${item.id}" class="option-modal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#fff; padding:20px; border-radius:5px; box-shadow:0 0 10px rgba(0,0,0,0.1); z-index:1000;">
                                            <h4>옵션 변경</h4>
                                            <div class="option-selects" style="margin:15px 0;">
                                                <div class="color-select" style="margin-bottom:10px;">
                                                    <label>색상:</label>
                                                    <select class="form-select color-selector"><option value="">색상 선택</option></select>
                                                </div>
                                                <div class="size-select">
                                                    <label>사이즈:</label>
                                                    <select class="form-select size-selector"><option value="">사이즈 선택</option></select>
                                                </div>
                                            </div>
                                            <div class="stock-info" style="margin:10px 0; font-size:0.9em; color:#666;">재고: <span class="current-stock">0</span>개</div>
                                            <div class="modal-buttons" style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px;">
                                                <button type="button" class="btn btn-primary confirm-option" style="padding:5px 15px;">변경</button>
                                                <button type="button" class="btn btn-secondary close-modal" style="padding:5px 15px;" onclick="closeOptionModal(this)">취소</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="opt_chg">
                                        <div class="box_qty">
                                            <a href="javascript:void(0);" class="ea_down" th:data-item-id="${item.id}" onclick="updateQuantity(this.getAttribute('data-item-id'), -1)"></a>
                                            <input type="text" th:value="${item.quantity}" class="form_input" readonly>
                                            <a href="javascript:void(0);" class="ea_up" th:data-item-id="${item.id}" onclick="updateQuantity(this.getAttribute('data-item-id'), 1)"></a>
                                        </div>
                                    </div>
                                    <div class="price">
                                        <p th:text="${#numbers.formatInteger(item.price, 0, 'COMMA') + '원'}">가격</p>
                                    </div>
                                    <div class="delete_wish">
                                        <a href="javascript:" onclick="alert('좋아요 기능은 개발 중입니다.')"><div class="wish-icon"></div></a>
                                        <a href="javascript:void(0);" th:onclick="'deleteCartItem(' + ${item.id} + ')'">
                                            <img src="https://atimg.sonyunara.com/attrangs/assets/web03/asset/img/shop/icon_del.png" alt="삭제">
                                        </a>
                                    </div>
                                </form>
                            </li>
                        </ul>
                    </div>

                    <!-- 오른쪽 요약 영역 -->
                    <div class="area_right">
                        <div class="box">
                            <div class="price-wrap">
                                <div class="price-title">선택한 상품 <span id="selectedItemCount">0</span>개</div>
                                <div class="price-won"><span id="selectedTotalPrice">0</span>원</div>
                                <div style="text-align: center;">배송비<span id="del_account">0</span>원
                                    <div class="deliveryInfo">
                                        <img src="https://atimg.sonyunara.com/attrangs/2019/icon/i.gif" style="vertical-align: middle; width:19px;">
                                        <span>80,000원이상</span> 구매시 <span>무료배송</span> 입니다.
                                    </div>
                                </div>
                                <div style="color:#333"><span id="selectedTotalPrice2"><strong id="use_account">0</strong></span>원</div>
                            </div>
                            <div class="btn-custom tac">
                                <span style="background-color:var(--season_color_01); width:62px; padding:7px 0; border:1px solid #cfcfcf; position:relative; text-align:center; display:inline-block; top:13px; height:62px" onclick="alert('선물하기는 모바일에서 이용가능합니다');" class="giftspanBtn">
                                    <a href="javascript:" style="background:transparent; display:block;">
                                        <img src="https://atimg.sonyunara.com/2023/renew/list/gift.png" alt="" style="width:25px;">
                                        <p style="margin-top:3px; font-size:12px;">선물하기</p>
                                    </a>
                                </span>
                                <span class="okbox"><a href="javascript:void(0);" onclick="orderSelectedItems()">선택상품 주문하기</a></span>
                                <span class="canbox"><a href="javascript:" onclick="alert('전체상품 주문 기능은 개발 중입니다.');">전체상품 주문하기</a></span>
                            </div>
                        </div>
                    </div>
                    <div class="clear"></div>
                    <br>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        // 원본 스크립트 (핵심 로직 유지)
        async function getProductOptions(productId) {
            try {
                const res = await fetch(`/cart/product/options/${productId}`);
                if(!res.ok) throw new Error('옵션 정보를 가져오는데 실패했습니다.');
                return await res.json();
            } catch(e){ console.error(e); return []; }
        }
        async function openOptionModal(btn){
            const modal = document.getElementById(`optionModal-${btn.getAttribute('data-item-id')}`);
            const colorSelect = modal.querySelector('.color-selector');
            const sizeSelect = modal.querySelector('.size-selector');
            const stockInfo = modal.querySelector('.current-stock');
            const confirmBtn = modal.querySelector('.confirm-option');
            const productId = btn.getAttribute('data-product-id');
            const itemId = btn.getAttribute('data-item-id');
            const currentColor = btn.getAttribute('data-color');
            const currentSize = btn.getAttribute('data-size');
            const clone = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(clone, confirmBtn);
            clone.addEventListener('click', ()=>updateCartItemOption(itemId, colorSelect.value, sizeSelect.value));
            const options = await getProductOptions(productId);
            const colors = [...new Set(options.map(o=>o.color))];
            colorSelect.innerHTML = '<option value="">색상 선택</option>' + colors.map(c=>`<option value="${c}" ${c===currentColor?'selected':''}>${c}</option>`).join('');
            if(currentColor){
                const sizes = options.filter(o=>o.color===currentColor);
                sizeSelect.innerHTML = '<option value="">사이즈 선택</option>' + sizes.map(o=>`<option value="${o.size}" ${o.size===currentSize?'selected':''}>${o.size}</option>`).join('');
                const cur = options.find(o=>o.color===currentColor && o.size===currentSize);
                if(cur) stockInfo.textContent = cur.stock;
            }
            colorSelect.addEventListener('change',()=>{
                const sel = colorSelect.value;
                const sizes = options.filter(o=>o.color===sel);
                sizeSelect.innerHTML = '<option value="">사이즈 선택</option>' + sizes.map(o=>`<option value="${o.size}">${o.size}</option>`).join('');
                stockInfo.textContent='0';
            });
            sizeSelect.addEventListener('change',()=>{
                const selColor = colorSelect.value;
                const selSize = sizeSelect.value;
                const opt = options.find(o=>o.color===selColor && o.size===selSize);
                stockInfo.textContent = opt? opt.stock : '0';
            });
            modal.style.display='block';
        }
        function closeOptionModal(b){ b.closest('.option-modal').style.display='none'; }
        async function updateCartItemOption(id,color,size){
            if(!color||!size){ alert('색상과 사이즈를 모두 선택해주세요.'); return; }
            try {
                const res= await fetch(`/cart/update-option/${id}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({color,size})});
                if(!res.ok){ const err=await res.json(); throw new Error(err.message||'옵션 변경 실패'); }
                location.reload();
            }catch(e){ alert(e.message); }
        }
        function toggleAllItems(){
            const checked = document.getElementById('selectAll').checked;
            document.querySelectorAll('.itemCheckbox').forEach(c=>c.checked=checked);
            updateTotalPrice();
        }
        function updateQuantity(id,delta){
            fetch(`/cart/update/${id}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({quantity:delta})})
                .then(r=>{if(r.ok) location.reload(); else throw new Error('수량 변경 실패');})
                .catch(e=>alert(e.message));
        }
        function deleteCartItem(id){
            if(!confirm('선택한 상품을 삭제하시겠습니까?')) return;
            fetch(`/cart/remove/${id}`,{method:'DELETE'})
              .then(r=>{ if(r.ok){ document.getElementById(`cartItem-${id}`).remove(); updateTotalPrice(); } else throw new Error('삭제 실패'); })
              .catch(e=>alert(e.message));
        }
        function deleteSelectedItems(){
            const ids=[...document.querySelectorAll('.itemCheckbox:checked')].map(c=>c.value);
            if(ids.length===0){ alert('선택된 상품이 없습니다.'); return; }
            if(!confirm('선택한 상품들을 삭제하시겠습니까?')) return;
            Promise.all(ids.map(i=>fetch(`/cart/remove/${i}`,{method:'DELETE'})))
              .then(()=>location.reload())
              .catch(()=>alert('삭제 중 오류가 발생했습니다.'));
        }
        function updateTotalPrice(){
            let total=0; const checked=[...document.querySelectorAll('.itemCheckbox:checked')];
            checked.forEach(ch=>{
                const li=ch.closest('li');
                const price=parseInt(li.querySelector('.price p').textContent.replace(/[^0-9]/g,''));
                const qty=parseInt(li.querySelector('.form_input').value);
                total+=price*qty;
            });
            document.getElementById('selectedItemCount').textContent=checked.length;
            document.getElementById('selectedTotalPrice').textContent=total.toLocaleString();
            document.getElementById('selectedTotalPrice2').textContent=total.toLocaleString();
            document.getElementById('selectedCount').textContent=checked.length;
        }
        function orderSelectedItems(){
            const ids=[...document.querySelectorAll('.itemCheckbox:checked')].map(c=>c.value);
            if(ids.length===0){ alert('주문할 상품을 선택해주세요.'); return; }
            location.href='/order/checkout?items='+ids.join(',');
        }
        document.addEventListener('DOMContentLoaded',updateTotalPrice);
    </script>

    <link href="/css/productCart.css" rel="stylesheet"/>
</body>
</html>