<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <div th:replace="~{fragments/header.html :: fragment-header}"></div>
    <title>AI ìƒí’ˆ ì¶”ì²œ | Sungho Shop</title>
    <!-- AI Recommendation Styles -->
    <link href="/css/ai-recommendation.css" rel="stylesheet"/>
</head>
<body>
    <!-- Navigation -->
    <div th:insert="~{fragments/nav.html :: fragment-nav}"></div>

    <div class="ai-recommendation-container">
        <!-- Header -->
        <div class="ai-chat-header">
            <h1><i class="fas fa-robot"></i> AI ìƒí’ˆ ì¶”ì²œ</h1>
            <p>ì–´ë–¤ ìƒí’ˆì„ ì°¾ê³  ê³„ì‹ ê°€ìš”? AIê°€ ë§ì¶¤í˜• ìƒí’ˆì„ ì¶”ì²œí•´ë“œë¦½ë‹ˆë‹¤.</p>
        </div>

        <!-- Chat Container -->
        <div class="chat-container">
            <!-- Messages Area -->
            <div class="chat-messages" id="chatMessages">
                <!-- Welcome Message -->
                <div class="welcome-message" id="welcomeMessage">
                    <h3>ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹</h3>
                    <p>ì›í•˜ëŠ” ìƒí’ˆì— ëŒ€í•´ ììœ ë¡­ê²Œ ë§ì”€í•´ì£¼ì„¸ìš”.<br>
                    ì˜ˆ: "ìš´ë™í•  ë•Œ ì…ì„ í¸í•œ ì˜· ì¶”ì²œí•´ì¤˜", "ê²¨ìš¸ì— ì‹ ì„ ë”°ëœ»í•œ ì‹ ë°œ"</p>

                    <div class="quick-suggestions">
                        <button class="suggestion-btn" onclick="sendQuickMessage('ìºì£¼ì–¼í•œ ì˜· ì¶”ì²œí•´ì¤˜')">
                            ğŸ§¥ ìºì£¼ì–¼ ì˜ë¥˜
                        </button>
                        <button class="suggestion-btn" onclick="sendQuickMessage('ìš´ë™í™” ì¶”ì²œí•´ì¤˜')">
                            ğŸ‘Ÿ ìš´ë™í™”
                        </button>
                        <button class="suggestion-btn" onclick="sendQuickMessage('ê²¨ìš¸ ì•„ìš°í„° ì¶”ì²œí•´ì¤˜')">
                            ğŸ§¥ ê²¨ìš¸ ì•„ìš°í„°
                        </button>
                        <button class="suggestion-btn" onclick="sendQuickMessage('ê°€ì„±ë¹„ ì¢‹ì€ ìƒí’ˆ ì¶”ì²œí•´ì¤˜')">
                            ğŸ’° ê°€ì„±ë¹„ ìƒí’ˆ
                        </button>
                    </div>
                </div>

                <!-- Loading Indicator -->
                <div class="loading-indicator" id="loadingIndicator">
                    <div class="loading-dots">
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                    </div>
                    <span>AIê°€ ì¶”ì²œ ìƒí’ˆì„ ì°¾ê³  ìˆìŠµë‹ˆë‹¤...</span>
                </div>
            </div>

            <!-- Input Area -->
            <div class="chat-input-container">
                <form class="chat-input-form" id="chatForm">
                    <input type="text"
                           class="chat-input"
                           id="messageInput"
                           placeholder="ì–´ë–¤ ìƒí’ˆì„ ì°¾ê³  ê³„ì‹ ê°€ìš”?"
                           maxlength="500"
                           required>
                    <button type="submit" class="chat-send-btn" id="sendBtn">
                        <i class="fas fa-paper-plane"></i>
                        ì „ì†¡
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        class AIRecommendationChat {
            constructor() {
                this.conversationId = null;
                this.isLoading = false;
                this.initializeEventListeners();
                this.startConversation();
            }

            initializeEventListeners() {
                const chatForm = document.getElementById('chatForm');
                const messageInput = document.getElementById('messageInput');

                chatForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.sendMessage();
                });

                // Enter key handling
                messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
            }

            async startConversation() {
                try {
                    const response = await fetch('/api/conversation/start', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.getJwtToken()}`
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.conversationId = data.conversationId;
                        console.log('ëŒ€í™” ì‹œì‘ë¨:', data);
                    } else {
                        this.showError('ëŒ€í™”ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    }
                } catch (error) {
                    console.error('ëŒ€í™” ì‹œì‘ ì˜¤ë¥˜:', error);
                    this.showError('ì„œë²„ì™€ì˜ ì—°ê²°ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.');
                }
            }

            async sendMessage() {
                const messageInput = document.getElementById('messageInput');
                const message = messageInput.value.trim();

                if (!message || this.isLoading || !this.conversationId) {
                    return;
                }

                // Hide welcome message
                const welcomeMessage = document.getElementById('welcomeMessage');
                if (welcomeMessage) {
                    welcomeMessage.style.display = 'none';
                }

                // Add user message to chat
                this.addMessage(message, 'user');

                // Clear input and show loading
                messageInput.value = '';
                this.showLoading();

                try {
                    const response = await fetch(`/api/conversation/${this.conversationId}/message`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.getJwtToken()}`
                        },
                        body: JSON.stringify({ message: message })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.handleAIResponse(data);
                    } else {
                        throw new Error('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨');
                    }
                } catch (error) {
                    console.error('ë©”ì‹œì§€ ì „ì†¡ ì˜¤ë¥˜:', error);
                    this.showError('ë©”ì‹œì§€ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                } finally {
                    this.hideLoading();
                }
            }

            addMessage(content, type) {
                const chatMessages = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;

                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.innerHTML = type === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';

                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';
                messageContent.textContent = content;

                messageDiv.appendChild(avatar);
                messageDiv.appendChild(messageContent);
                chatMessages.appendChild(messageDiv);

                this.scrollToBottom();
            }

            handleAIResponse(data) {
                // Add AI response message
                this.addMessage(data.aiResponse, 'ai');

                // Add recommendations if available
                const products = data.recommendedProducts || data.recommendations || [];
                if (products.length > 0) {
                    this.addRecommendations(products);
                }
            }

            addRecommendations(recommendations) {
                const chatMessages = document.getElementById('chatMessages');
                const recommendationsContainer = document.createElement('div');
                recommendationsContainer.className = 'message ai';

                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.innerHTML = '<i class="fas fa-robot"></i>';

                const recommendationsContent = document.createElement('div');
                recommendationsContent.className = 'message-content';
                recommendationsContent.style.maxWidth = '90%';

                const title = document.createElement('p');
                title.innerHTML = `<strong>ğŸ›ï¸ ì¶”ì²œ ìƒí’ˆ (${recommendations.length}ê°œ)</strong>`;
                title.style.marginBottom = '1rem';
                recommendationsContent.appendChild(title);

                const grid = document.createElement('div');
                grid.className = 'recommendations-grid';

                recommendations.forEach(product => {
                    const card = this.createRecommendationCard(product);
                    grid.appendChild(card);
                });

                recommendationsContent.appendChild(grid);
                recommendationsContainer.appendChild(avatar);
                recommendationsContainer.appendChild(recommendationsContent);
                chatMessages.appendChild(recommendationsContainer);

                this.scrollToBottom();
            }

            createRecommendationCard(product) {
                const card = document.createElement('a');
                card.className = 'recommendation-card';

                // ProductResponseDto ë˜ëŠ” ProductMatch í˜•íƒœ ì²˜ë¦¬
                const productId = product.number || product.id;
                const productName = product.name;
                const productPrice = product.price || '';
                const productImage = product.imageUrl || '/img/placeholder-product.jpg';
                const productScore = product.relevance || product.score || 0;

                card.href = `/product/detail/${productId}`;
                card.target = '_blank';

                card.innerHTML = `
                    <img src="${productImage}" alt="${productName}" class="recommendation-image"
                         onerror="this.src='/img/placeholder-product.jpg'">
                    <div class="recommendation-info">
                        <div class="recommendation-name">${productName}</div>
                        ${productPrice ? `<div class="recommendation-price">${productPrice}</div>` : ''}
                        <div class="recommendation-score">
                            <i class="fas fa-star"></i> ë§¤ì¹­ë„ ${Math.round(productScore * 100)}%
                        </div>
                    </div>
                `;

                return card;
            }

            showLoading() {
                this.isLoading = true;
                const loadingIndicator = document.getElementById('loadingIndicator');
                const sendBtn = document.getElementById('sendBtn');

                loadingIndicator.style.display = 'flex';
                sendBtn.disabled = true;

                this.scrollToBottom();
            }

            hideLoading() {
                this.isLoading = false;
                const loadingIndicator = document.getElementById('loadingIndicator');
                const sendBtn = document.getElementById('sendBtn');

                loadingIndicator.style.display = 'none';
                sendBtn.disabled = false;
            }

            showError(message) {
                const chatMessages = document.getElementById('chatMessages');
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
                chatMessages.appendChild(errorDiv);
                this.scrollToBottom();
            }

            scrollToBottom() {
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            getJwtToken() {
                // ì¿ í‚¤ì—ì„œ JWT í† í° ê°€ì ¸ì˜¤ê¸°
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [name, value] = cookie.trim().split('=');
                    if (name === 'accessToken') {
                        return value;
                    }
                }
                return localStorage.getItem('jwt') || sessionStorage.getItem('jwt') || '';
            }
        }

        // Quick message function for suggestion buttons
        function sendQuickMessage(message) {
            const messageInput = document.getElementById('messageInput');
            messageInput.value = message;

            if (window.aiChat) {
                window.aiChat.sendMessage();
            }
        }

        // Initialize chat when page loads
        document.addEventListener('DOMContentLoaded', function() {
            window.aiChat = new AIRecommendationChat();
        });
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>